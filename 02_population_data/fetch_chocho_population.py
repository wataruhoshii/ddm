"""
å·å´å¸‚ ç”ºä¸åˆ¥å¹´é½¢åˆ¥äººå£ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ»æ•´å½¢ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹: å·å´å¸‚ã‚ªãƒ¼ãƒ—ãƒ³ãƒ‡ãƒ¼ã‚¿
URL: https://www.city.kawasaki.jp/170/page/0000181218.html
"""

import pandas as pd
import requests
import re

def download_data():
    """å·å´å¸‚ã‹ã‚‰ç”ºä¸åˆ¥å¹´é½¢åˆ¥äººå£ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰"""
    url = "https://www.city.kawasaki.jp/170/cmsfiles/contents/0000181/181218/opendata202510.csv"
    response = requests.get(url)
    response.raise_for_status()
    
    # Shift-JISã§ãƒ‡ã‚³ãƒ¼ãƒ‰
    content = response.content.decode('shift-jis')
    
    # UTF-8ã§ä¿å­˜
    with open('kawasaki_chocho_age_utf8.csv', 'w', encoding='utf-8') as f:
        f.write(content)
    
    print("ğŸ“¥ ãƒ‡ãƒ¼ã‚¿ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Œäº†: kawasaki_chocho_age_utf8.csv")
    return pd.read_csv('kawasaki_chocho_age_utf8.csv')

def process_data(df):
    """ãƒ‡ãƒ¼ã‚¿ã‚’æ•´å½¢"""
    print("ğŸ”„ ãƒ‡ãƒ¼ã‚¿æ•´å½¢ä¸­...")
    
    # ç”ºåã‹ã‚‰åŒºã‚’æŠ½å‡º
    df['åŒº'] = df['ç”ºå'].str.extract(r'(å·å´åŒº|å¹¸åŒº|ä¸­åŸåŒº|é«˜æ´¥åŒº|å®®å‰åŒº|å¤šæ‘©åŒº|éº»ç”ŸåŒº)')
    
    # ç”ºåã‚’æ•´å½¢ï¼ˆä½™åˆ†ãªã‚¹ãƒšãƒ¼ã‚¹ã‚’é™¤å»ï¼‰
    df['ç”ºå_æ•´å½¢'] = df['ç”ºå'].str.replace(r'\s+', '', regex=True)
    df['ç”ºä¸å'] = df['ç”ºå_æ•´å½¢'].str.replace(r'^(å·å´åŒº|å¹¸åŒº|ä¸­åŸåŒº|é«˜æ´¥åŒº|å®®å‰åŒº|å¤šæ‘©åŒº|éº»ç”ŸåŒº)', '', regex=True)
    
    # å¿…è¦ãªã‚«ãƒ©ãƒ ã‚’é¸æŠã—ã¦æ•´å½¢
    result_df = pd.DataFrame({
        'ç”ºä¸ã‚³ãƒ¼ãƒ‰': df['ç”ºä¸ã‚³ãƒ¼ãƒ‰'],
        'åŒº': df['åŒº'],
        'ç”ºä¸å': df['ç”ºä¸å'],
        'ç·äººå£': df['ç·è¨ˆ'],
        '0-14æ­³': df['ï¼âˆ’ï¼‘ï¼”æ­³'],
        '15-64æ­³': df['ï¼‘ï¼•âˆ’ï¼–ï¼”æ­³'],
        '65æ­³ä»¥ä¸Š': df['ï¼–ï¼•æ­³ä»¥ä¸Š'],
        '75æ­³ä»¥ä¸Š': df['ï¼—ï¼•æ­³ä»¥ä¸Š'],
        '0-4æ­³': df['ï¼âˆ’ï¼”æ­³'],
        '5-9æ­³': df['ï¼•âˆ’ï¼™æ­³'],
        '10-14æ­³': df['ï¼‘ï¼âˆ’ï¼‘ï¼”æ­³'],
        '15-19æ­³': df['ï¼‘ï¼•âˆ’ï¼‘ï¼™æ­³'],
        '20-24æ­³': df['ï¼’ï¼âˆ’ï¼’ï¼”æ­³'],
        '25-29æ­³': df['ï¼’ï¼•âˆ’ï¼’ï¼™æ­³'],
        '30-34æ­³': df['ï¼“ï¼âˆ’ï¼“ï¼”æ­³'],
        '35-39æ­³': df['ï¼“ï¼•âˆ’ï¼“ï¼™æ­³'],
        '40-44æ­³': df['ï¼”ï¼âˆ’ï¼”ï¼”æ­³'],
        '45-49æ­³': df['ï¼”ï¼•âˆ’ï¼”ï¼™æ­³'],
        '50-54æ­³': df['ï¼•ï¼âˆ’ï¼•ï¼”æ­³'],
        '55-59æ­³': df['ï¼•ï¼•âˆ’ï¼•ï¼™æ­³'],
        '60-64æ­³': df['ï¼–ï¼âˆ’ï¼–ï¼”æ­³'],
        '65-69æ­³': df['ï¼–ï¼•âˆ’ï¼–ï¼™æ­³'],
        '70-74æ­³': df['ï¼—ï¼âˆ’ï¼—ï¼”æ­³'],
        '75-79æ­³': df['ï¼—ï¼•âˆ’ï¼—ï¼™æ­³'],
        '80-84æ­³': df['ï¼˜ï¼âˆ’ï¼˜ï¼”æ­³'],
        '85-89æ­³': df['ï¼˜ï¼•âˆ’ï¼˜ï¼™æ­³'],
        '90-94æ­³': df['ï¼™ï¼âˆ’ï¼™ï¼”æ­³'],
        '95æ­³ä»¥ä¸Š': df['ï¼™ï¼•âˆ’ï¼™ï¼™æ­³'] + df.get('ï¼‘ï¼ï¼âˆ’ï¼‘ï¼ï¼”æ­³', 0) + df.get('ï¼‘ï¼ï¼•âˆ’ï¼‘ï¼ï¼™æ­³', 0) + df.get('ï¼‘ï¼‘ï¼âˆ’ï¼‘ï¼‘ï¼”æ­³', 0) + df.get('ï¼‘ï¼‘ï¼•æ­³ä»¥ä¸Š', 0),
        'é«˜é½¢åŒ–ç‡': df['ï¼–ï¼•æ­³ä»¥ä¸Šå‰²åˆ'],
        'å¾ŒæœŸé«˜é½¢åŒ–ç‡': df['ï¼—ï¼•æ­³ä»¥ä¸Šå‰²åˆ'],
    })
    
    return result_df

def main():
    print("=" * 60)
    print("å·å´å¸‚ ç”ºä¸åˆ¥å¹´é½¢åˆ¥äººå£ãƒ‡ãƒ¼ã‚¿å–å¾—")
    print("=" * 60)
    
    # æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Œã°èª­ã¿è¾¼ã¿ã€ãªã‘ã‚Œã°ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
    try:
        df = pd.read_csv('kawasaki_chocho_age_utf8.csv')
        print("ğŸ“‚ æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿: kawasaki_chocho_age_utf8.csv")
    except FileNotFoundError:
        df = download_data()
    
    # ãƒ‡ãƒ¼ã‚¿æ•´å½¢
    result_df = process_data(df)
    
    # ä¿å­˜
    output_file = 'kawasaki_chocho_age_processed.csv'
    result_df.to_csv(output_file, index=False, encoding='utf-8-sig')
    print(f"ğŸ’¾ ä¿å­˜å®Œäº†: {output_file}")
    
    # çµ±è¨ˆè¡¨ç¤º
    print("\n" + "=" * 60)
    print("ğŸ“Š ãƒ‡ãƒ¼ã‚¿ã‚µãƒãƒªãƒ¼")
    print("=" * 60)
    print(f"ç”ºä¸æ•°: {len(result_df)}")
    print(f"ç·äººå£: {result_df['ç·äººå£'].sum():,} äºº")
    
    print(f"\nã€åŒºåˆ¥çµ±è¨ˆã€‘")
    ward_stats = result_df.groupby('åŒº').agg({
        'ç·äººå£': 'sum',
        '65æ­³ä»¥ä¸Š': 'sum',
        '75æ­³ä»¥ä¸Š': 'sum',
        'ç”ºä¸ã‚³ãƒ¼ãƒ‰': 'count'
    }).rename(columns={'ç”ºä¸ã‚³ãƒ¼ãƒ‰': 'ç”ºä¸æ•°'})
    ward_stats['é«˜é½¢åŒ–ç‡'] = (ward_stats['65æ­³ä»¥ä¸Š'] / ward_stats['ç·äººå£'] * 100).round(1)
    ward_stats['å¾ŒæœŸé«˜é½¢åŒ–ç‡'] = (ward_stats['75æ­³ä»¥ä¸Š'] / ward_stats['ç·äººå£'] * 100).round(1)
    print(ward_stats.to_string())
    
    print(f"\nã€é«˜é½¢åŒ–ç‡ä¸Šä½10ç”ºä¸ã€‘")
    top_aging = result_df.nlargest(10, 'é«˜é½¢åŒ–ç‡')[['åŒº', 'ç”ºä¸å', 'ç·äººå£', '65æ­³ä»¥ä¸Š', 'é«˜é½¢åŒ–ç‡']]
    print(top_aging.to_string(index=False))
    
    return result_df

if __name__ == '__main__':
    main()



